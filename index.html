<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HLS Player With Quality Selector</title>
  <style>
    body {
      background: #0b0f14;
      color: #e6eef6;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 10px;
    }
    .container {
      width: 95%;
      max-width: 900px;
    }
    video {
      width: 100%;
      border-radius: 10px;
      background: black;
    }
    .controls {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
    }
    select {
      padding: 6px 10px;
      border-radius: 6px;
      background: #071018;
      color: #e6eef6;
      border: 1px solid #1f7aef;
    }
  </style>
</head>
<body>
  <div class="container">
    <video id="video" controls autoplay muted></video>

    
    <div class="controls">
      <label>
        Quality:
        <select id="qualitySelect">
          <option value="auto">Auto</option>
        </select>
      </label>
      <button id="unmuteBtn" style="padding: 6px 15px; border-radius: 6px; background: #1f7aef; color: white; border: none; cursor: pointer;">
    ðŸ”ˆ Unmute
        </button>
    </div>
  </div>

  <div id="instructions" style="margin-top: 15px; padding: 15px; background: #161b22; border-left: 4px solid #1f7aef; border-radius: 4px; font-size: 14px; line-height: 1.6;">
  <h4 style="margin: 0 0 10px 0; color: #1f7aef;">ðŸ“º Quick Guide</h4>
  <ul style="margin: 0; padding-left: 20px; color: #b1bac4;">
    <li><b>Sound:</b> Tap the <b>Unmute</b> button to enable audio.</li>
    <li><b>Buffering:</b> If it freezes, wait 5 - 15 seconds; it will <b>auto-refresh</b>.</li>
    <li><b>Quality:</b> Use the dropdown if your internet is slow.</li>
    <li><b>Ads:</b> The player may jump slightly during ad breaksâ€”this is normal.</li>
  </ul>
</div>
  
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
      const video = document.getElementById("video");
      const qualitySelect = document.getElementById("qualitySelect");
      const API_BASE = window.location.origin;

      const originalUrl = "https://cfd-v4-service-channel-stitcher-use1-1.prd.pluto.tv/stitch/hls/channel/6675c7868768aa0008d7f1c7/master.m3u8?terminate=false&appName=web&appVersion=unknown&clientTime=0&deviceDNT=0&deviceId=d3595b5a-7553-4a6b-b9dd-c30951631395&deviceMake=Chrome&deviceModel=web&deviceType=web&deviceVersion=unknown&includeExtendedEvents=false&serverSideAds=false&sid=bc32713f-dc5f-45d9-8650-2b4e69506b23";
      const hlsUrl = `${API_BASE}/proxy?url=${encodeURIComponent(originalUrl)}`;

      let hls;

      // --- THE NUCLEAR OPTION (Clears all browser memory for this site) ---
      async function nukeAndReload() {
          console.warn("ðŸš€ 10s STALL: Performing Full Data Nuke & Reload...");
          
          // 1. Clear Standard Storage
          localStorage.clear();
          sessionStorage.clear();

          // 2. Clear All Cookies
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i];
              const eqPos = cookie.indexOf("=");
              const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
              document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
          }

          // 3. Clear Cache Storage (The most important part for HLS)
          if ('caches' in window) {
              const cacheNames = await caches.keys();
              await Promise.all(cacheNames.map(name => caches.delete(name)));
          }

          // 4. Clear IndexedDB
          if (window.indexedDB && window.indexedDB.databases) {
              const dbs = await window.indexedDB.databases();
              dbs.forEach(db => window.indexedDB.deleteDatabase(db.name));
          }

          // 5. Final Reload
          window.location.reload();
      }

      // --- INTERNAL NUDGE (Stage 1 Recovery) ---
      function forceRecover() {
          console.warn("ðŸ› ï¸ Stage 1: Flushing buffer and nudging playhead...");
          const currentTime = video.currentTime;
          hls.stopLoad(); 
          video.currentTime = currentTime + 0.1;
          hls.startLoad();
      }

      if (Hls.isSupported()) {
          hls = new Hls({
              liveSyncDurationCount: 3,
              maxStarvationDelay: 1,
              nudgeOffset: 0.1,
              nudgeMaxRetry: 5,
              enableWorker: true,
              lowLatencyMode: true
          });

          hls.loadSource(hlsUrl);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
              qualitySelect.innerHTML = '<option value="auto">Auto</option>';
              hls.levels.forEach((level, index) => {
                  let opt = document.createElement("option");
                  opt.value = index;
                  opt.textContent = level.height ? `${level.height}p` : `Level ${index}`;
                  qualitySelect.appendChild(opt);
              });
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
              if (data.fatal) {
                  if (data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
                  else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
                  else nukeAndReload(); // Fatal unknown error triggers the nuke
              }
          });

          qualitySelect.addEventListener("change", () => {
              const value = qualitySelect.value;
              hls.currentLevel = (value === "auto") ? -1 : parseInt(value);
          });

      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = hlsUrl;
      }

      // Unmute Button Logic
      const unmuteBtn = document.getElementById("unmuteBtn");
      unmuteBtn.addEventListener("click", () => {
          video.muted = !video.muted;
          unmuteBtn.textContent = video.muted ? "ðŸ”ˆ Unmute" : "ðŸ”Š Mute";
      });

      // --- AGGRESSIVE HEARTBEAT ---
      let lastTime = -1;
      let stuckCounter = 0;

      setInterval(() => {
          if (hls && !video.paused && video.readyState >= 2) {
              const currentPos = video.currentTime;

              // 1. Detect Stalling
              if (lastTime > 0 && Math.abs(currentPos - lastTime) < 0.2) {
                  stuckCounter++;
                  console.warn(`ðŸ¢ Stall Counter: ${stuckCounter}/10`);
              } else {
                  stuckCounter = 0;
              }

              // 2. Loop Detection
              if (lastTime > 0 && currentPos < lastTime - 0.5) {
                  console.error("ðŸ”„ Loop detected!");
                  nukeAndReload();
                  return;
              }

              // 3. Multi-Stage Recovery
              if (stuckCounter === 5) {
                  // First try the light nudge
                  forceRecover();
              } 
              else if (stuckCounter >= 10) {
                  // If still stuck 5 seconds after the nudge, nuke the storage
                  nukeAndReload();
              }

              lastTime = currentPos;
          }
      }, 1000);
  </script>

</body>
</html>
