<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./images/tomjerry.jpg" type="image/x-icon">
    <title>Tom & Jerry – Live</title>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root {
        --bg: #0c0a09;
        --card: #1c1917cc;
        --border: #292524;
        --amber: #fbbf24;
        --text: #f5f5f4;
        --muted: #a8a29e;
        }

        * { box-sizing: border-box; }

        body {
        margin: 0;
        font-family: system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
        }

        .container {
        max-width: 1280px;
        margin: auto;
        padding: 1rem;
        }

        .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 1.5rem;
        padding: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        }

        .poster {
        width: 260px;
        height: 260px;
        border-radius: 1rem;
        overflow: hidden;
        border: 2px solid rgba(251,191,36,.3);
        box-shadow: 0 0 30px rgba(251,191,36,.1);
        }

        .poster img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 1rem;
        }

        .info {
        flex: 1;
        min-width: 280px;
        }

        .title {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 900;
        color: var(--amber);
        }

        .genre {
        color: var(--muted);
        margin-top: .25rem;
        }

        .plot {
        margin-top: 1rem;
        padding-left: 1rem;
        border-left: 4px solid var(--amber);
        background: rgba(41,37,36,.3);
        }

        .meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: .75rem;
        margin-top: 1rem;
        }

        .meta div {
        background: #292524cc;
        padding: .75rem;
        border-radius: .75rem;
        border: 1px solid var(--border);
        }

        .video-wrap {
        margin-top: 2rem;
        position: relative;
        border-radius: 1.5rem;
        overflow: hidden;
        border: 1px solid var(--border);
        }

        video {
        width: 100%;
        height: auto;
        background: #000;
        }

        .controls {
        display: flex;
        justify-content: flex-end;
        gap: .5rem;
        padding: .75rem;
        background: #000;
        }

        select {
        background: #1c1917;
        color: #fff;
        border: 1px solid var(--border);
        padding: .4rem .6rem;
        border-radius: .5rem;
        }

    .back {
        margin-bottom: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        text-decoration: none;
        background: #fbbf24;
        color: black;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-size: 1.2rem;
        transition: all 0.2s ease;
        backdrop-filter: blur(8px);
    }

    .back:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #fbbf24; /* Or your theme color */
        color: #fbbf24;
        transform: translateX(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    </style>
</head>

<body>

    <div class="container">
    <a href="https://giveth-station.vercel.app/tv" title="Back to Tv Page" class="back">&larr;</a>
    <div class="card">
        <div class="poster">
        <img src="./images/tomjerry.jpg" alt="Tom & Jerry">
        </div>

        <div class="info">
        <div class="title">Tom & Jerry</div>
        <div class="genre">Animation • Comedy • Kids</div>

        <div class="plot">
            Enjoy 24/7 non-stop slapstick comedy with the world’s most famous cat-and-mouse duo.
        </div>

        <div class="meta">
            <div><small>Quality</small><br><b>HD</b></div>
            <div><small>Status</small><br><b style="color:#4ade80">LIVE</b></div>
            <div><small>Network</small><br><b>BOZZ TV</b></div>
            <div><small>Language</small><br><b>English</b></div>
        </div>
        </div>
    </div>

    <div class="video-wrap">
        <div class="controls">
        <select id="quality">
            <option value="-1">Auto</option>
        </select>
        </div>
        <video id="video" controls autoplay muted playsinline></video>
    </div>

    </div>

    <script>
    const video = document.getElementById('video');
    const qualitySelect = document.getElementById('quality');
    const masterPlaylist = 'https://backend-channels-5al8.onrender.com/hls/master.m3u8';
    const serverPingEndpoint = 'https://backend-channels-5al8.onrender.com/server';

    /* ======================================================
    FRONTEND TS CACHE (IN-MEMORY)
    ====================================================== */
    const tsCache = new Map(); // url -> ArrayBuffer

    /* ======================================================
    SERVER KEEP-ALIVE (EVERY 15 SECONDS)
    ====================================================== */
    function keepServerAlive() {
    fetch(serverPingEndpoint).catch(() => {});
    }
    setInterval(keepServerAlive, 15000);
    keepServerAlive();

    /* ======================================================
    HLS SETUP
    ====================================================== */
    if (Hls.isSupported()) {
    const hls = new Hls({
        maxBufferLength: 60 * 60,        // buffer up to 1 hour
        maxMaxBufferLength: 60 * 60 * 4, // allow very large future buffer
        backBufferLength: 0,             // don't drop past buffer
        enableWorker: true,
        lowLatencyMode: false,
    });

    /* ======================================================
        CUSTOM LOADER WITH AGGRESSIVE TS CACHING
    ====================================================== */
    hls.config.loader = class extends Hls.DefaultConfig.loader {
        load(context, config, callbacks) {
        // Serve TS from cache if available
        if (context.type === 'fragment' && tsCache.has(context.url)) {
            callbacks.onSuccess(
            { data: tsCache.get(context.url) },
            context,
            null
            );
            return;
        }

        // Fetch normally
        super.load(context, config, {
            onSuccess: (response, ctx, stats) => {
            // Cache TS fragments permanently for this session
            if (ctx.type === 'fragment' && response?.data) {
                tsCache.set(ctx.url, response.data);
            }
            callbacks.onSuccess(response, ctx, stats);
            },
            onError: callbacks.onError,
            onTimeout: callbacks.onTimeout,
            onProgress: callbacks.onProgress,
        });
        }
    };

    hls.loadSource(masterPlaylist);
    hls.attachMedia(video);

    /* ======================================================
        FORCE LOADING ALL FUTURE SEGMENTS
    ====================================================== */
    hls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
        const details = data.details;
        if (!details || !details.fragments) return;

        details.fragments.forEach(frag => {
        const url = frag.url;
        if (!tsCache.has(url)) {
            fetch(url)
            .then(r => r.arrayBuffer())
            .then(buf => tsCache.set(url, buf))
            .catch(() => {});
        }
        });
    });

    /* ======================================================
        QUALITY SELECT (UNCHANGED)
    ====================================================== */
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
        qualitySelect.innerHTML = '<option value="-1">Auto</option>';

        hls.levels.forEach((level, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = `${level.height}p`;
        qualitySelect.appendChild(opt);
        });
    });

    qualitySelect.addEventListener('change', () => {
        hls.currentLevel = parseInt(qualitySelect.value, 10);
    });

    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = masterPlaylist;
    }
    </script>

</body>
</html>
